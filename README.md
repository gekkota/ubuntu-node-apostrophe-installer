# Apostrophe CMS Deployment Documentation

This documentation covers the three scripts used in the Apostrophe CMS deployment process:

1. `copy_and_run.sh` - Used to copy and execute the configuration script on remote servers
2. `configure.sh` - The main setup script that configures a server for Apostrophe CMS
3. `deploy.sh` - The deployment script that gets created for future code deployments

## 1. copy_and_run.sh

### Overview
This utility script simplifies the process of copying the `configure.sh` script to a remote server and executing it with appropriate permissions. It handles SSH connections, key management, and remote execution.

### Prerequisites
- SSH access to the target server
- Appropriate SSH key (.pem file) with permissions to access the server
- The `configure.sh` script in the same directory as `copy_and_run.sh`

### Usage
```bash
./copy_and_run.sh
```

### Parameters
The script prompts for the following parameters:
- **Server IP Address**: The IP address of the target server
- **Server Username**: The SSH username (defaults to "ubuntu" if left blank)
- **PEM Number**: Used to construct the PEM file path based on region (e.g., enter "2" for eu-west-2)

### Process
1. Prompts for server details and PEM file information
2. Constructs the appropriate PEM file path
3. Copies the `configure.sh` script to the remote server
4. Makes the script executable and runs it with sudo permissions
5. Displays output from the remote execution

### Example
```
$ ./copy_and_run.sh
Enter the server IP address: 18.175.135.229
Enter the server username (default: ubuntu): 
Enter the PEM number (default PEM: ~/www/threekey/LightsailDefaultKey-eu-west-3.pem): 2
Copying configure.sh to ubuntu@18.175.135.229...
PEM PATH: /Users/username/www/threekey/LightsailDefaultKey-eu-west-2.pem
configure.sh                                             100%   10KB 317.8KB/s   00:00
Setting configure.sh executable and running it on 18.175.135.229...
```

### Troubleshooting
- **Permission denied**: Ensure the PEM file has the correct permissions (chmod 400)
- **Connection refused**: Verify the server IP and that the server is running
- **Key not found**: Check that the PEM path is correct

---

## 2. configure.sh

### Overview
This is the main setup script that configures an Ubuntu 24.4 server (AWS Lightsail) with all necessary components for running Apostrophe CMS, including Node.js, nginx, varnish, PM2, MongoDB connection, and more.

### Prerequisites
- Ubuntu 24.4 server (AWS Lightsail instance)
- Root or sudo access
- Internet connectivity for package installation

### Usage
```bash
sudo ./configure.sh
```

### Important Note
This script must be run with sudo privileges. It will check for root access and exit if not running as root.

### Environment Variables
The script includes predefined environment variables for Apostrophe CMS:
- `ENVIRONMENT`: Set to 'production'
- `PROJECT_SHORTNAME`: Set to 'entertainers'
- `BASE_URL`: Set to 'https://entertainers.co.uk'
- `MONGODB_URI`: MongoDB connection string
- `APOS_STORAGE`: Set to 's3'
- `S3_BUCKET_NAME`: S3 bucket for assets
- `S3_BUCKET_REGION`: AWS region for S3
- `S3_ACCESS_KEY` & `S3_SECRET`: AWS credentials
- `CDN_ADDRESS`: CloudFront distribution URL
- `NEW_RELIC_LICENSE_KEY`: New Relic monitoring key

### Process
The script executes the following major steps:

1. **System Preparation**
   - Updates system packages
   - Installs Node.js 22.x
   - Installs and configures nginx and varnish

2. **User & Directory Setup**
   - Configures NPM global path for root
   - Installs PM2 globally
   - Creates the application user (apos)
   - Creates necessary directories
   - Sets up npm global directory for the apos user
   - Installs PM2 for the apos user

3. **SSH Configuration**
   - Sets up SSH authorized keys for the apos user
   - Configures SSH for Bitbucket access

4. **Service Configuration**
   - Configures Varnish as a reverse proxy
   - Sets up environment file with necessary variables
   - Creates deployment scripts

5. **Deployment Key Setup**
   - Generates an SSH deploy key for Bitbucket
   - Prompts to add the key to Bitbucket repository
   - Runs the initial deployment

6. **Cleanup**
   - Performs system cleanup
   - Reports completion status

### Logging
The script creates a detailed log at `/var/log/apostrophe_setup.log` with timestamps for each operation.

### Troubleshooting
- **Permission errors**: Ensure the script runs with sudo
- **Connection failures**: Check network connectivity
- **SSH key issues**: Verify the Bitbucket deploy key was added correctly
- **MongoDB connection issues**: Verify the MongoDB URI is correct

---

## 3. deploy.sh (Generated Deployment Script)

### Overview
This script is automatically generated by `configure.sh` and placed in `/home/apos/deploy-scripts/deploy.sh`. It handles pulling the latest code from your repository, installing dependencies, and restarting the Apostrophe CMS application using PM2.

### Prerequisites
- Already configured server using configure.sh
- Valid SSH access to the Bitbucket repository
- The apos user having appropriate permissions

### Usage
```bash
sudo -u apos /home/apos/deploy-scripts/deploy.sh
```

### Parameters
The script uses these key parameters (set during creation):
- `REPO_URL`: The Bitbucket repository URL
- `BRANCH`: The Git branch to deploy (set to "production")
- `APP_DIR`: Application directory (set to "/var/www/apostrophe")
- `PM2_INSTANCES`: Number of PM2 instances to run

### Process
1. **Repository Management**
   - Clones the repository if it doesn't exist
   - Updates to the latest code if the repository exists
   - Checks out the specified branch and pulls latest changes

2. **Dependency Installation**
   - Runs `npm install` to update dependencies

3. **Application Restart**
   - Stops any existing PM2 instances
   - Starts the application with PM2
   - Configures the specified number of instances

### Logging
The script creates a detailed log at `/home/apos/apostrophe_deploy.log` that includes:
- Timestamps for each operation
- Success or failure status of each command
- Summary of the deployment process

### Integration with CI/CD
This script is designed to be triggered when changes are pushed to the production branch of your repository. Common integration options:
- Webhook from Bitbucket to trigger deployment
- Scheduled deployment using cron
- Manual deployment by SSH'ing to the server

### Troubleshooting
- **Git access issues**: Verify SSH keys and repository permissions
- **npm install errors**: Check Node.js version compatibility
- **PM2 failures**: Check application logs in PM2
- **Permission issues**: Ensure the script runs as the apos user

---

## Security Considerations

1. **Secrets Management**
   - The S3 credentials and MongoDB URI contain sensitive information
   - Consider using a more secure method for managing these secrets in production

2. **SSH Keys**
   - The deploy key has access to the repository; protect it appropriately
   - Use read-only deploy keys when possible

3. **Environment File**
   - The environment file contains sensitive information and is chmod 600
   - Consider rotating credentials periodically

4. **User Permissions**
   - The setup follows the principle of least privilege with a dedicated app user
   - The apos user runs the application with limited system access

## Maintenance

1. **Updating the Application**
   - Run the deploy script to pull the latest code
   - `sudo -u apos /home/apos/deploy-scripts/deploy.sh`

2. **Monitoring Logs**
   - Setup logs: `/var/log/apostrophe_setup.log`
   - Deployment logs: `/home/apos/apostrophe_deploy.log`
   - Application logs: Check PM2 logs with `pm2 logs apostrophe`

3. **Backing Up**
   - MongoDB data should be backed up regularly
   - Consider backing up the /opt/env directory for environment configuration